server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # NOTE: Authentication headers are handled at the Kubernetes Ingress layer
    # This nginx container only serves static Angular files - it does NOT proxy requests
    # OAuth2-Proxy headers are set by the ingress nginx, not this container nginx
    # See: /Users/guymoyo/dev/fineract-gitops/apps/ingress/base/ingress.yaml

    # Static assets with caching
    location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc|woff|woff2|ttf|eot)$ {
        expires 1M;
        access_log off;
        add_header Cache-Control "public";
    }

    location ~* \.(?:css|js)$ {
        expires 1y;
        access_log off;
        add_header Cache-Control "public";
    }

    # API routing is NOT handled by this nginx container
    # Architecture: Browser → Kubernetes Ingress NGINX → Fineract API (direct)
    # This container only serves the static Angular SPA files
    # API calls from the browser are routed by the Kubernetes Ingress, not this nginx
    # See: /Users/guymoyo/dev/fineract-gitops/apps/ingress/base/ingress.yaml
    #      - fineract-oauth2-protected ingress handles /fineract-provider paths
    #      - fineract-web-app-protected ingress handles / paths (this app)
    location /fineract-provider/ {
        # If this location is ever reached, it means the request bypassed ingress
        # In normal operation, API calls never reach this nginx container
        return 404 "API routing is handled by Kubernetes Ingress, not this container";
    }

    # Angular SPA - All routes fallback to index.html
    # Serve files with /mifosweb prefix
    location /mifosweb/ {
        alias /usr/share/nginx/html/;
        try_files $uri $uri/ /mifosweb/index.html;
    }

    # Root fallback (in case direct access without prefix)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Disable logging for favicon
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    # Disable logging for robots.txt
    location = /robots.txt {
        log_not_found off;
        access_log off;
    }
}
